<!DOCTYPE html>
<html lang="bn">

<head>
  <meta charset="UTF-8">
  <title>Bengali to Thermal Print</title>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Bengali&display=swap" rel="stylesheet">

</head>

<body>
  <h3>Thermal Print Bengali (Image to Hex)</h3>
  <input type="text" id="text" value="বাংলা টেক্সট পরীক্ষা" />
  <canvas id="canvas" width="384"></canvas>
  <button onclick="startPrint()">Print</button>

  <script>
    const canvas = document.getElementById("canvas");
    const ctx = canvas.getContext("2d");

    function autoResizeCanvas(text, lineHeight = 48) {
      const lines = text.split('\n');
      const height = lines.length * lineHeight;
      canvas.width = 384;
      canvas.height = height;
      ctx.fillStyle = "white";
      ctx.fillRect(0, 0, canvas.width, canvas.height);
      ctx.font = "48px 'Noto Sans Bengali'";
      ctx.fillStyle = "black";
      ctx.textBaseline = "top";
      lines.forEach((line, i) => {
        ctx.fillText(line, 0, i * lineHeight);
      });
    }

    function imageToChunks(img, chunkHeight = 20) {
      const chunks = [];
      for (let y = 0; y < img.height; y += chunkHeight) {
        const imageData = ctx.getImageData(0, y, img.width, chunkHeight);
        const bytesPerRow = img.width / 8;
        const bytes = [];

        for (let row = 0; row < imageData.height; row++) {
          for (let col = 0; col < img.width; col += 8) {
            let byte = 0;
            for (let bit = 0; bit < 8; bit++) {
              const i = ((row * img.width) + col + bit) * 4;
              const avg = (imageData.data[i] + imageData.data[i + 1] + imageData.data[i + 2]) / 3;
              const pixel = avg < 128 ? 1 : 0;
              byte |= (pixel << (7 - bit));
            }
            bytes.push(byte);
          }
        }

        const base64 = btoa(String.fromCharCode(...bytes));
        chunks.push({ base64, height: chunkHeight });
      }
      return chunks;
    }

    async function startPrint() {
      const text = document.getElementById("text").value;
      autoResizeCanvas(text);
      const chunks = imageToChunks(canvas);

      for (let i = 0; i < chunks.length; i++) {
        const payload = {
          width: 384,
          height: chunks[i].height,
          data: chunks[i].base64
        };

        try {
          await fetch("http://192.168.0.96/data", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload)
          });
          await new Promise(resolve => setTimeout(resolve, 100)); // Short delay
        } catch (e) {
          console.error("Chunk send failed", e);
          break;
        }
      }

      console.log("All chunks sent.");
    }

  </script>
</body>

</html>